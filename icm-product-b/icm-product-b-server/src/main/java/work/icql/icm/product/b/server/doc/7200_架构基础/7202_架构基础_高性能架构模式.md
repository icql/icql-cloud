---
title: 架构基础_高性能架构模式
date: 2022-09-08 11:31:21
---

# 架构基础_高性能架构模式

## 一、存储高性能

### 1. 关系型数据库

#### 1) 读写分离

* 主从集群，一主多从，主机负责读写，从机负责只读
* 集群数据复制方式：同步复制、异步复制
* 主从延迟问题

#### 2) 分库分表

* 按业务分库
* 分表：
    * 垂直拆分：将常用字段和非常用字段分开存储，例如商品基本信息表+商品详情表
    * 水平拆分：针对数据量过大进行拆分

### 2. NoSQL数据库

* kv存储：如redis，rockDB引擎的存储
* 文档数据库：如MongoDB
* 列式数据库：如clickhouse
* 全文搜索引擎：如elasticsearch

### 3. 缓存

适用场景：
```
1) 需要复杂计算才能得出的数据
2) 读多写少，绝大部分都是读多写少，减少存储读压力
```

缓存问题：
```
1) 缓存穿透
2) 缓存雪崩
3) 缓存击穿
4) 缓存热点

具体解决方案详见【缓存】
```


## 二、计算高性能

### 1.单服务器高性能

#### 1) 高性能IO模型
```
(1) PPC(Process per Connection): 有连接来fork子进程处理
(2) prefork: 预先fork子进程池子，来处理随时回来的请求，减少fork代价
(3) TPC(Thread per Connection): 每次有新的连接就新建一个线程去专门处理请求。 比进程轻量
(4) prethread: 预先创建线程
(5) Reactor模型  
  * 单Reactor单进程/线程
  * 单Reactor多进程/线程
  * 多Reactor多进程/线程* Reactor模型（具体详见【Reactor模型】）
(6) Proactor模型
```

### 2.集群高性能

#### 1) 负载均衡

* 地理级别负载均衡：dns根据用户IP返回不同地区（例如北京、上海、广州）的机房IP
* 集群级别负载均衡：广州机房使用F5负载均衡设备，F5转发给多个本地集群中的一个（例如广州集群2）
* 机器级别负载均衡：广州集群2的负载均衡使用的是Nginx，转发给其中一个机器

(1) DNS负载均衡
```
域名解析到不同的ip
```

(2) 硬件负载均衡
```
通过单独的设备做负载均衡，例如F5，支持百万级的并发
```

(3) 软件负载均衡
```
通过软件进行负载均衡，例如Nginx、LVS

Nginx: 7层（应用层）负载均衡，支持HTTP协议等，万级并发
LVS: 4层（传输层）负载均衡，TCP/UDP等，十万级并发
```

#### 2) 常见架构

* (1) 地理级别负载均衡：dns根据用户IP返回不同地区（例如北京、上海、广州）的机房IP
* (2) 集群级别负载均衡：广州机房使用F5负载均衡设备，F5转发给多个本地集群中的一个（例如广州集群2）
* (3) 机器级别负载均衡：广州集群2的负载均衡使用的是Nginx，转发给其中一个机器

### 3) 负载均衡算法
轮询、加权轮询（性能好的机器加大权重）、负载最低优先、Hash等等